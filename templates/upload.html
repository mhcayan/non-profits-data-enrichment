<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nonprofit Data Enrichment</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>

    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            max-width: 720px;
            margin: auto;
        }
        .mini-spinner {
            display: none;
        }
        .action-section {
            margin-top: 2rem;
        }
        .btn-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
    </style>
</head>

<body class="pt-5">
    <div class="container">
        <div class="card shadow p-4">
            <h2 class="text-center mb-2">Upload Your Nonprofit IRS Data Spreadsheet</h2>
            <p class="text-center text-muted mb-4">Weâ€™ll enrich your data with geocoding, census tract information, and more.</p>

            <!-- Upload Form -->
            <form id="uploadForm" method="post" action="/upload/" enctype="multipart/form-data">
                <div class="mb-3">
                    <input class="form-control" type="file" name="file" required>
                </div>
                <div class="d-grid">
                    <button type="submit" id="uploadBtn" class="btn btn-primary">Upload File</button>
                </div>
            </form>

            <!-- Upload Spinner -->
            <div id="loadingSpinner" class="text-center mt-3" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Uploading...</span>
                </div>
                <p class="mt-2">Processing... Please wait</p>
            </div>

            <!-- Alerts -->
            {% if message %}
                <div class="alert mt-4 alert-{{ 'success' if 'successfully' in message else 'danger' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endif %}

            <!-- Preview -->
            {% if preview %}
                <h5 class="mt-4">Preview of Uploaded Data</h5>
                <div class="table-responsive border rounded p-2 bg-light">
                    {{ preview | safe }}
                </div>
            {% endif %}

            <!-- Action Buttons -->
            {% if enriched_filename is defined and enriched_filename|length > 0 %}
            <div class="action-section">
                <div class="row row-cols-1 row-cols-md-2 g-3">
                    {% for action, label, style in [
                        ('geocode', 'Add Geocoding', 'success'),
                        ('census', 'Add Census Tract', 'warning'),
                        ('both', 'Add Geocoding + Census Tract', 'danger')
                    ] %}
                    <div class="col">
                        <form method="post" action="/process/{{ action }}" class="processing-form-wrapper btn-wrapper">
                            <input type="hidden" name="filename" value="{{ enriched_filename }}">
                            <button type="submit" class="btn btn-{{ style }} w-100 processing-btn">{{ label }}</button>
                            <div class="text-center mini-spinner">
                                <div class="spinner-border spinner-border-sm text-{{ style }}" role="status"></div>
                                <p class="mb-0 small">Processing...</p>
                            </div>
                        </form>
                    </div>
                    {% endfor %}

                    <!-- Active Social Media Button -->
                    <div class="col">
                        <div class="btn-wrapper">
                            <button type="button" id="socialFeatureBtn" class="btn btn-info w-100">Recommend Social Media Pages</button>
                            <div id="socialFeatureAlert" class="alert alert-warning mt-2 d-none" role="alert">
                                ðŸš§ This feature is still under development.
                            </div>
                        </div>
                    </div>

                    <!-- Download -->
                    {% if download_link %}
                    <div class="col">
                        <a href="{{ download_link }}" class="btn btn-dark w-100">Download Enriched File</a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function disableAllButtons() {
                document.querySelectorAll("button, a.btn").forEach(el => {
                    el.setAttribute("disabled", "disabled");
                    el.classList.add("disabled");
                });
            }

            // Upload Spinner
            const uploadForm = document.getElementById('uploadForm');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadSpinner = document.getElementById('loadingSpinner');

            uploadForm.addEventListener('submit', function (event) {
                event.preventDefault();
                disableAllButtons();
                uploadBtn.style.display = 'none';
                uploadSpinner.style.display = 'block';
                setTimeout(() => {
                    uploadForm.submit();
                }, 100);
            });

            // Processing Buttons
            document.querySelectorAll('.processing-form-wrapper').forEach(form => {
                form.addEventListener('submit', function () {
                    disableAllButtons();
                    const button = form.querySelector('.processing-btn');
                    const miniSpinner = form.querySelector('.mini-spinner');

                    button.style.display = 'none';
                    miniSpinner.style.display = 'block';
                });
            });

            // Social Media Feature Button
            const socialBtn = document.getElementById("socialFeatureBtn");
            const socialAlert = document.getElementById("socialFeatureAlert");

            if (socialBtn && socialAlert) {
                socialBtn.addEventListener("click", () => {
                    disableAllButtons();
                    socialAlert.classList.remove("d-none");
                    setTimeout(() => {
                        socialAlert.classList.add("d-none");
                        document.querySelectorAll("button, a.btn").forEach(el => {
                            el.removeAttribute("disabled");
                            el.classList.remove("disabled");
                        });
                    }, 4000);
                });
            }
        });
    </script>
</body>
</html>
